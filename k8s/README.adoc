= Install K3S on RPI4

== On the RPI

=== cleanup

* k3s-uninstall.sh
* for i in {,6}; do for t in {filter,nat,mangle}; do ip${i}tables -F -t $t; done; done;

=== install k3s

* export K3S_NODE_NAME="homepi"
* curl -sfL https://get.k3s.io | sh -s - --disable servicelb --disable traefik -i 192.168.8.16

== On the PC

=== Connect to k3s

* scp homepi:/etc/rancher/k3s/k3s.yaml ~/.config/kube/config
* sed 's/127.0.0.1/192.168.8.16/g' -i ~/.config/kube/config
* kubectl cluster-info

=== install Metallb

* kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/namespace.yaml
* kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.5/manifests/metallb.yaml
* kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"
* kubectl apply -f metallb.yaml

=== install traefik

* kubectl create namespace traefik
* helm repo add traefik https://helm.traefik.io/traefik
* helm repo update
* kubectl apply -f traefik-config.yaml
* helm install traefik traefik/traefik --namespace=traefik --values=traefik-chart-values.yaml
* wait for kubectl get pods --all-namespaces to complete

=== install cert-manager

* kubectl create namespace cert-manager
* helm repo add jetstack https://charts.jetstack.io
* helm repo update
* helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v1.2.0 --create-namespace --set installCRDs=true --set 'extraArgs={--dns01-recursive-nameservers-only,--dns01-recursive-nameservers=8.8.8.8:53\,1.1.1.1:53}'
* helm repo add smueller18 https://smueller18.gitlab.io/helm-charts
* helm repo update
* helm install --namespace cert-manager cert-manager-webhook-inwx smueller18/cert-manager-webhook-inwx
* kubectl apply -f issuer-secret.yaml
* kubectl apply -f certmanager-issuer.yaml 

=== Install default cert

* kubectl apply -f default-cert.yaml

=== Install Rancher

* kubectl create namespace cattle-system
* kubectl apply -f rancher-cert.yaml
* helm repo add rancher-latest https://releases.rancher.com/server-charts/latest
* helm repo update
* helm install rancher rancher-latest/rancher --namespace cattle-system --set hostname=rancher.bergmann.click --set ingress.tls.source=secret --set ingress.extraAnnotations.'certmanager\.io/cluster-issuer'=letsencrypt-prod --set ingress.extraAnnotations.'kubernetes\.io/ingress\.class'=traefik  

=== Ingress for legacy Services

* kubectl apply -f legacy-proxy.yaml
